<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title><%=title%></title>
    <link rel="stylesheet" type="text/css" href="/stylesheets/jquery.dataTables.css">
    <link rel="stylesheet" type="text/css" href="/stylesheets/shCore.css">
    <link rel="stylesheet" type="text/css" href="/stylesheets/demo.css">
    <style type="text/css" class="init">
        td.temp {}
        td.highlight {
            border:3px solid red;
        }
        #user_color ul li{
            display:inline;
            margin-right: 30px;
        }
    </style>
    <script type="text/javascript" language="javascript" src="/javascripts/jquery-2.1.3.min.js"></script>
    <script type="text/javascript" language="javascript" src="/javascripts//jquery.dataTables.js"></script>
    <script type="text/javascript" language="javascript" src="/javascripts/shCore.js"></script>
    <script type="text/javascript" language="javascript" src="/javascripts/demo.js"></script>
    <script type="text/javascript" language="javascript" class="init">
        function select_cell(cnt)
        {
            var t;
            if ( $('#cel'+cnt).hasClass('highlight') ) {
                $('#cel'+cnt).removeClass('highlight');
                t=0;
            }
            else {
                $('#cel'+cnt).addClass('highlight');
                t=1;
            }
            $.ajax({
                url: '/schedule/progress/select_cell',
                type: 'POST',
                data: {
                    "t": t,
                    "ridx": '<%=s_ridx%>',
                    "uidx": '<%=s_uidx%>',
                    "pos":cnt
                },
                success: function(result)
                {
                }, error: function(req,status,error) {
                    alert("서버와 통신 도중 에러가 발생하였습니다.");
                    alert("code:"+req.status+"\n"+"message:"+req.responseText+"\n"+"error:"+error);
                }
            });//ajax
        }
        function init_color()
        { //접속한 놈에 컬러 표시
            $.ajax({
                url: '/schedule/progress/init_color',
                type: 'POST',
                data: {
                    "ridx": '<%=s_ridx%>',
                    "uidx": '<%=s_uidx%>'
                },
                success: function(result)
                {
                    $('#now_name').html(result.name);
                    $('#now_name_right').css("background-color", result.color);
                }, error: function(req,status,error) {
                    alert("서버와 통신 도중 에러가 발생하였습니다.");
                    alert("code:"+req.status+"\n"+"message:"+req.responseText+"\n"+"error:"+error);
                }
            });//ajax
        } //function init_color
        function set_schedule()
        { // 프로젝트 기간과 작업에 따라 동적 테이블 만듬
            var innerSource = "";
            innerSource += "<thead><tr><th>프로젝트 일정</th>";
            $.ajax({
                url: '/schedule/progress/setting', //테이블 세팅
                type: 'POST',
                data: {
                    "ridx": '<%=s_ridx%>',
                    "uidx": '<%=s_uidx%>'
                },
                success: function(result)
                {
                    //프로젝트 진행 기간을 계산_start
                    var one_t = new Date(result.s_date);
                    var two_t = new Date(result.e_date);
                    var cnt = 0,i= 0,j=0;
                    var mont=0;
                    if(result.type)  //0: 일  1: 주차
                        one_t.setDate( one_t.getDate()-one_t.getDay() );
                    while(one_t <= two_t) //1월 2월을 계산. colspan 계산
                    {
                        for(i=1,mont = one_t.getMonth();(one_t<=two_t) && (one_t.getMonth() == mont);++i)
                        {
                            if(result.type)
                                one_t.setDate(one_t.getDate()+7);
                            else
                                one_t.setDate(one_t.getDate()+1);
                        }
                        --i;
                        innerSource += "<th colspan=\""+i+"\">"+(mont+1)+"월</th>";
                    }
                    innerSource += "</tr><tr>";
                    if(result.type) //0: 일  1: 주차
                        innerSource += "<th>작업＼주차</th>";
                    else
                        innerSource += "<th>작업＼날짜</th>";
                    one_t = new Date(result.s_date);
                    if(result.type) //프로젝트 날짜 or 주차 계산
                    {
                        one_t.setDate( one_t.getDate()-one_t.getDay() );
                        cnt = 1;
                        while(one_t <= two_t)
                        {
                            innerSource += "<th>"+cnt+"</th>";
                            one_t.setDate(one_t.getDate()+7);
                            ++cnt;
                        }
                    }
                    else
                    {
                        while(one_t <= two_t)
                        {
                            innerSource += "<th>"+one_t.getDate()+"</th>";
                            one_t.setDate(one_t.getDate()+1);
                        }
                    }
                    innerSource += "</tr></thead>";
                    //프로젝트 진행 기간을 계산_end
                    //job 이랑 해당 날짜 색칠 계산
                    var t_col = result.col;
                    var t_row = result.row;
                    var cnt_d = 0,cnt_p=0;
                    result.s_data.push(-1,-1,-1);
                    result.sp_progress.push(-1,-1);
                    cnt = 0;
                    innerSource += "<tbody>";
                    for(i=0;i<t_col;++i)
                    {//job 써주고
                        innerSource += "<tr>";
                        innerSource += "<td style=\"text-align: center;\">"+result.sj_job[i].job+"</td>";

                        for(j=0;j<t_row;++j,++cnt) // 날짜 색칠 계산하고
                        {
                            if(cnt == result.s_data[cnt_d].position) // 그 셀이 계획 색칠된 일정인지
                            {
                                if(cnt == result.sp_progress[cnt_p].position) // 그 셸이 진행 색칠된 일정인지
                                {
                                    if('<%=s_uidx%>' == result.sp_progress[cnt_p].uidx) // 자기꺼인지
                                        innerSource += "<td id=\"cel"+cnt+"\" class='highlight' style=\"background-color:"+result.s_data[cnt_d].color+";\" onclick=\"select_cell("+cnt+")\"></td>";
                                    else
                                        innerSource += "<td id=\"cel"+cnt+"\" class='highlight' style=\"background-color:"+result.s_data[cnt_d].color+";\" ></td>";
                                    ++cnt_p;
                                }
                                else //계획됬지만 현재 진행되지 않은 일정
                                {
                                    if('<%=s_uidx%>' == result.s_data[cnt_d].uidx) // 자기 계획인지
                                        innerSource += "<td id=\"cel"+cnt+"\" style=\"background-color:"+result.s_data[cnt_d].color+";\" onclick=\"select_cell("+cnt+")\"></td>";
                                    else
                                        innerSource += "<td id=\"cel"+cnt+"\" style=\"background-color:"+result.s_data[cnt_d].color+";\" ></td>";
                                }
                                ++cnt_d;
                            }
                            else
                            {
                                innerSource += "<td id=\"cel"+cnt+"\"></td>";
                            }
                        }
                        innerSource += "</tr>";
                    }
                    innerSource += "</tbody>";
                    $('#schedul_table').html(innerSource);

                }, error: function(req,status,error) {
                    alert("서버와 통신 도중 에러가 발생하였습니다."); //실패시 실행부분
                    alert("code:"+req.status+"\n"+"message:"+req.responseText+"\n"+"error:"+error);
                }
            });//ajax
        } //set_schedule

        $(document).ready(function() {
            init_color();
            set_schedule();
            var lastIdx = null;
            var table = $('#schedul_table').DataTable({
                "paging":   false,
                "searching": false,
                "ordering": false,
                "info":     false
            });

        }); //ready
    </script>
</head>
<body class="dt-example">
<% if (exist) {%> <!--계획한 일정이 있을 경우-->
<div class="container">
    <section>
        <h1 style="text-align: center;">프로젝트 일정 관리 프로그램</h1>
        <table id="schedul_table" class="display cell-border compact" cellspacing="0" width="100%"><thead><tr><th></th></tr></thead></table>
        <div>Now, Select user: <span id="now_name"></span><span id="now_name_right" style="width:50px;margin-left: 5px;">　</span></div>
    </section>
</div>
<% } else {%> <!--계획한 일정이 없을 경우 -->
<script language="javascript">
    alert('계획된 프로젝트 일정이 없습니다.\n 관리자에게 문의바랍니다.');
    opener = self;
    window.close();
</script>
<% }%>
</body>
</html>