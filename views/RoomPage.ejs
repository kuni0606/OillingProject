<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title><%=title%></title>
    <link rel="stylesheet" href="/stylesheets/avgrund_style.css">
    <link rel="stylesheet" href="/stylesheets/avgrund.css">
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="/stylesheets/jquery-ui.css">
    <!-- Latest compiled and minified JavaScript -->
    <script src="/javascripts/canvas2image.js"></script>
    <style type="text/css">
        iframe {
            margin-top: 20px;
            margin-bottom: 30px;

            -moz-border-radius: 12px;
            -webkit-border-radius: 12px;
            border-radius: 12px;

            -moz-box-shadow: 4px 4px 14px #000;
            -webkit-box-shadow: 4px 4px 14px #000;
            box-shadow: 4px 4px 14px #000;

            filter:progid:DXImageTransform.Microsoft.BasicImage(rotation=.2);
        }
        label, input { display:block; }
        input.text { margin-bottom:12px; width:95%; padding: .4em; }
        fieldset { padding:0; border:0; margin-top:25px; }
        h1 { font-size: 1.2em; margin: .6em 0; }
        .ui-dialog .ui-state-error { padding: .3em; }
        .validateTips { border: 1px solid transparent; padding: 0.3em; }
    </style>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/javascripts/jquery-2.1.3.min.js"></script>
    <script src="/javascripts/jquery.avgrund.js"></script>
    <script src="/javascripts/jquery-ui.js"></script>
    <script>
        var socket;
        $(document).ready(function(){
            socket = io.connect();

            var w=screen.availWidth;
            var h=screen.availHeight;

            $('.room_menu').css('width', w/16);
            $('.room_menu').css('height', w/16);
            $('.room_menu').css('background-size', w/16, w/16);
        });

        $(function() {
            var invite = document.getElementById('invite_friend');
            var name = $( "#name" ),
                    allFields = $( [] ).add( name ),
                    tips = $( ".validateTips" );
            var emailRegex = /^[a-zA-Z0-9.!#$%&'*+\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;

            var dialog = $( "#dialog-form" ).dialog({
                autoOpen: false,
                height: 400,
                width: 350,
                resizable: false,
                modal: true,
                buttons: {
                    "Create": addUser,
                    Cancel: function() {
                        dialog.dialog( "close" );
                    }
                },
                close: function() {
                    form[ 0 ].reset();
                    allFields.removeClass( "ui-state-error" );
                }
            });

            function updateTips( t ) {
                tips
                        .text( t )
                        .addClass( "ui-state-highlight" );
                setTimeout(function() {
                    tips.removeClass( "ui-state-highlight", 1500 );
                }, 500 );
            }
            function checkLength( o, n, min, max ) {
                if ( o.val().length > max || o.val().length < min ) {
                    o.addClass( "ui-state-error" );
                    updateTips( n + " 의 길이는 " +
                    min + " 에서 " + max + "사이여야 합니다." );
                    return false;
                } else {
                    return true;
                }
            }
            function checkRegexp( o, regexp, n ) {
                if ( !( regexp.test( o.val() ) ) ) {
                    o.addClass( "ui-state-error" );
                    updateTips( n );
                    return false;
                } else {
                    return true;
                }
            }

            function addUser() {
                var valid = true;
                allFields.removeClass( "ui-state-error" );

                valid = valid && checkLength( name, "이메일", 3, 50 );

                valid = valid && checkRegexp( name, emailRegex, "이메일 형식에 맞지 않습니다." );

                if ( valid ) {
                    var params = 'email='+name.val();
                    var xhr = new XMLHttpRequest();
                    xhr.open('post', '/room/api/invite', false);
                    xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                    xhr.overrideMimeType('application/json');
                    xhr.send(params);
                    if (xhr.status==200){
                        alert('초대 요청이 완료되었습니다');
                        dialog.dialog( "close" );
                    }else if (xhr.status==400){
                        alert('해당 이메일을 찾지 못했습니다.');
                    }
                }
                return valid;
            }
            form = dialog.find( "form" ).on( "submit", function( event ) {
                event.preventDefault();
                addUser();
            });
            invite.addEventListener('click',function(e){
                dialog.dialog('open');
            });
        });
        function check_auth () {
            socket.emit('auth_check', {ridx:'<%=s_ridx%>',uidx:'<%=s_uidx%>'}, function (data) {
                if (data) {//프로젝트 관리자가 계획or진행을 선택한다.
                    $(function() {
                        $('#show').avgrund({
                            height: 100,
                            width: 230,
                            holderClass: 'custom',
                            showClose: true,
                            showCloseText: 'Close',
                            enableStackAnimation: true,
                            onBlurContainer: '.container',
                            //프로젝트계획 혹은 진행
                            template: '<br/><div>' +
                            '<a href="#" class="twitter" onclick="pla()">Plan</a>' +
                            '<a href="#" class="dribble" onclick="pro()">Progress</a>' +
                            '</div>'
                        });
                    });
                } else { //걍 팀원은 진행만 볼 수 있다.
                    $(function() {
                        $('#show').avgrund({
                            height: 100,
                            width: 150,
                            holderClass: 'custom',
                            showClose: true,
                            showCloseText: 'Close',
                            enableStackAnimation: true,
                            onBlurContainer: '.container',
                            //프로젝트계획 혹은 진행
                            template: '<br/><div>' +
                            '<a href="#" class="dribble" onclick="pro()">Progress</a>' +
                            '</div>'
                        });
                    });

                }
            });
        }
        function confer()
        {
            log_go();
            window.href = "/video";
        }
        function log_go () {
            var n_json={};
            var now = new Date();
            var mi = now.getMinutes();
            if(mi <10)
                mi = "0" + mi;
            now = now.getFullYear() + "-" + (now.getMonth() + 1) + "-" + now.getDate() + " " + now.getHours() + ":" +mi;
            n_json.ridx = '<%=s_ridx%>';
            n_json.uidx = '<%=s_uidx%>';
            n_json.name = '<%=s_name%>';
            n_json.content = '화상회의에 접속하였습니다.';
            n_json.date = now;
            socket.emit('log_go', n_json);
            top.document.log_frame.location.reload();
            window.location.href='/video';
        }
        function toHome(){
            window.location.href='/main';
        }
        //고쳐~~~~~~아래링크~~~~~~~~localhost~~~~~~~~~
        function pla(){window.open( '/schedule/plan/s?uidx=<%=s_uidx%>&ridx=<%=s_ridx%>','_blank', 'height=' + screen.height + ',width=' + screen.width + 'fullscreen=yes');}
        function pro(){window.open( '/schedule/progress/s?uidx=<%=s_uidx%>&ridx=<%=s_ridx%>','_blank', 'height=' + screen.height + ',width=' + screen.width + 'fullscreen=yes');}
    </script>
    <style type="text/css">
        html{
            height: 100%;
        }
        body{
            position:absolute; top:0; bottom:0; right:0; left:0;
            background-image: url("/images/roompage.png"); background-size:100% 100%;
        }
        .room_menu{
            transition-duration: 0.5s;
            -webkit-animation: showSlowlyElement 700ms;
        }
        .room_menu:hover{
            transform: scale(1.2,1.2) translateZ(60px);
        }
        ::-webkit-scrollbar {
            width: 10px;
            background: #000000;
        }
        ::-webkit-scrollbar-track {
            background: #000000;
            -webkit-box-shadow: inset 0 0 6px rgba(0,0,0,0.3);
            -webkit-border-radius: 10px;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            -webkit-border-radius: 10px;
            border-radius: 10px;
            background: rgba(79,118,130,0.8);
            -webkit-box-shadow: inset 0 0 6px rgba(0,0,0,0.5);
        }
        ::-webkit-scrollbar-thumb:window-inactive {
            background: rgba(255,0,0,0.4);
        }
    </style>
</head>
<body style="height:100%; width:auto;">
<div style="height:100%;width:100%; overflow: hidden;">
    <div style="height:100%;width:15%;float:left;">
        <div style="margin-bottom: 20px; margin-top:40px;"><img class="room_menu" id="video_C" style="cursor:pointer; display:block; margin-left:auto; margin-right:auto;" onclick="confer();" src="/images/video.png" onmouseover='this.src="/images/video_hover.png"' onmouseout='this.src="/images/video.png"'></div>
        <div style="margin-bottom:30px;"><img class="room_menu" src="/images/invite.png" id="invite_friend" style="cursor:pointer; display:block; margin-left:auto; margin-right:auto;" onmouseover='this.src="/images/invite_hover.png"' onmouseout='this.src="/images/invite.png"'></div>
        <div style="margin-bottom:20px;"><img class="room_menu" src="/images/calendar.png" id="show" style="cursor:pointer; display:block; margin-left:auto; margin-right:auto;" onclick="check_auth()" onmouseover='this.src="/images/calender_hover.png"' onmouseout='this.src="/images/calendar.png"'></div>
        <div style="margin-bottom:20px;"><a href="/main"><img class="room_menu" src="/images/toHome.png" id="toHome" style="cursor:pointer; display:block; margin-left:auto; margin-right:auto;" onclick="toHome()" onmouseover='this.src="/images/toHome_hover.png"' onmouseout='this.src="/images/toHome.png"'></a></div>
    </div>
    <div style="height:80%;width:70%;float:left; text-align: center;">
        <iframe name="fexp" src="/file" scrolling="no" frameborder="3" height="96%" width="99%" ></iframe>
    </div>
    <div style="height:65%;width:15%;float:left;">
        <iframe name="log_frame" src="/log" scrolling="no" frameborder="3" height="96%" width="99%" ></iframe>
    </div>
</div>
<div id="dialog-form" title="회원 초대" style="background-color:ivory" >
    <p class="validateTips">초대할 회원의 이메일을 입력해주십시오.</p>

    <form>
        <fieldset>
            <label for="name">이메일</label>
            <input type="text" name="name" id="name" value="" class="text ui-widget-content ui-corner-all">

            <!-- Allow form submission with keyboard without duplicating the dialog button -->
            <input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
        </fieldset>
    </form>
</div>
</body>
</html>